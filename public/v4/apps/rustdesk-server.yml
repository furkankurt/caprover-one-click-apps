captainVersion: 4
services:
  hbbr:
    image: rustdesk/rustdesk-server:$$cap_version
    command: hbbr
    volumes:
      - $$cap_appname-data:/root
    ports:
      - "21117:21117"      # Relay (TCP)
      - "21119:21119"      # (optional) Web client relay (TCP)
    caproverExtra:
      notExposeAsWebApp: "true"

  hbbs:
    image: rustdesk/rustdesk-server:$$cap_version
    command: hbbs
    environment:
      - ALWAYS_USE_RELAY=$$cap_always_use_relay
    volumes:
      - $$cap_appname-data:/root
    ports:
      - "21115:21115"      # NAT type test (TCP)
      - "21116:21116"      # ID/heartbeat/connection over TCP
      - "21118:21118"      # (optional) Web client broker (TCP)
      - "21114:21114"      # (optional) Pro web console (TCP)
    depends_on:
      - hbbr
    caproverExtra:
      notExposeAsWebApp: "true"

caproverOneClickApp:
  variables:
    - id: '$$cap_version'
      label: RustDesk Server Image Tag
      defaultValue: 'latest'
      description: 'Docker tag for rustdesk/rustdesk-server (e.g., latest)'
      validRegex: '/.{1,}/'

    - id: '$$cap_always_use_relay'
      label: ALWAYS_USE_RELAY
      defaultValue: 'Y'
      description: 'Y or N â€” set Y to avoid UDP dependency on CapRover/Swarm'
      validRegex: '/^(Y|N|y|n)$/'

  instructions:
    start: |-
      This One-Click App deploys a **RustDesk self-hosted server**.
      Since RustDesk Server is **not an HTTP app**, it doesnâ€™t use CapRover ingress.
      The containers listen directly on these ports (TCP only on CapRover):

        hbbs:
          - 21115/TCP â€” NAT type test
          - 21116/TCP â€” ID/heartbeat/connection (UDP not exposed on CapRover)
          - 21118/TCP â€” (optional) Web client support
          - 21114/TCP â€” (optional) Pro web console
        hbbr:
          - 21117/TCP â€” Relay
          - 21119/TCP â€” (optional) Web client support

      ðŸ” **Open firewall ports (copy/paste all):**
      ```bash
      sudo ufw allow 21115/tcp
      sudo ufw allow 21116/tcp
      sudo ufw allow 21117/tcp
      # Optional (enable only if you need them)
      sudo ufw allow 21118/tcp
      sudo ufw allow 21119/tcp
      sudo ufw allow 21114/tcp
      ```

      ðŸ’¾ Data is stored persistently in CapRover volume `$$cap_appname-data` mounted at `/root`.

      ðŸ§ª On CapRover, set `ALWAYS_USE_RELAY=Y` to avoid reliance on UDP 21116.

    end: |-
      âœ… **RustDesk Server deployment completed successfully!**

      The **ID key** is generated on first run of `hbbs`. Find it here in your data volume:
      ```
      /captain/data/config-caprover-volumes/$$cap_appname-data/id_ed25519.pub
      ```

      **Use these in RustDesk client â†’ Settings â†’ Network:**
      ```
      ID Server: $$cap_appname.$$cap_root_domain
      Relay Server: $$cap_appname.$$cap_root_domain
      API Server: https://$$cap_appname.$$cap_root_domain
      Key: contents of id_ed25519.pub (see path above)
      ```

  displayName: RustDesk Server
  isOfficial: false
  description: >
    Self-host your own RustDesk server. RustDesk is a full-featured open source remote control
    alternative for self-hosting and security with minimal configuration.
  documentation: 'https://github.com/rustdesk/rustdesk-server'
